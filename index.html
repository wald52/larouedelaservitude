<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La roue de la servitude</title>

<!-- PWA -->
<link rel="manifest" href="/larouedelaservitude/site.webmanifest">
<meta name="theme-color" content="#FFFFFF">

<!-- Favicons -->
<link rel="icon" href="/larouedelaservitude/icons/favicon.ico" type="image/x-icon">

<!-- Apple support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="La roue de la servitude">
<link rel="apple-touch-icon" sizes="180x180" href="/larouedelaservitude/icons/favicon-180x180.png">

<!-- Police -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
  --bg:#f7f7f7; --fg:#111; --ring:#e5e7eb;
  --emoji-size:80px; --bg-size:200vw;
}
html, body {
  height:100%; margin:0; font-family:'Poppins',sans-serif;
  background:var(--bg); color:var(--fg);
  overflow:hidden; overscroll-behavior:contain; touch-action:none;
}
body::before, body::after {
  content:""; position:fixed; z-index:0; width:var(--bg-size); height:var(--bg-size);
  top:calc(50% - var(--bg-size)/2); left:calc(50% - var(--bg-size)/2);
  pointer-events:none;
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'><text x='40' y='40' font-size='50'>‚ò≠</text><text x='120' y='120' font-size='50'>‚ò≠</text></svg>");
  background-repeat:repeat; background-size:var(--emoji-size) var(--emoji-size);
}
body::after { background-position:calc(var(--emoji-size)/2) calc(var(--emoji-size)/2); }

.wrap { position:relative; z-index:1; min-height:100vh; display:flex; flex-direction:column; align-items:center;
  padding-top:clamp(24px,6vh,80px); padding-bottom:24px; box-sizing:border-box; }
.container { width:100%; max-width:720px; padding-inline:12px; display:grid; gap:12px; justify-items:center; }
h1 { margin:0; font-size:clamp(18px,2.6vw,22px); font-weight:700; text-transform:uppercase; text-align:center; }
h1 .highlight { background:#c00; color:#fff; padding:4px 10px; border-radius:6px; }

.board { background:#fff; border:1px solid var(--ring); border-radius:12px; padding:8px; display:grid;
  gap:8px; justify-items:center; max-width:560px; box-sizing:border-box; }
.wheel-area { position:relative; width:100%; display:grid; place-items:center; }
.pointer { position:absolute; top:0; left:50%; transform:translateX(-50%);
  width:0; height:0; z-index:6; --w:14px; --h:22px;
  border-left:var(--w) solid transparent; border-right:var(--w) solid transparent;
  border-top:var(--h) solid #111;
}
canvas { width:clamp(250px,80vw,540px); aspect-ratio:1/1; display:block;
  border-radius:50%; background:#fafafa; box-shadow:inset 0 0 0 5px #f0f0f0;
}
.controls { display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
button.primary { background:#111; color:#fff; border:none; border-radius:8px; padding:8px 12px;
  font-size:13px; font-weight:700; cursor:pointer;
}
.legend { font-size:12px; color:#666; }

.overlay {
  position:fixed; top:0; left:0; right:0; bottom:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.35); z-index:9999;
}
.bubble {
  position:relative; max-width:92%; padding:20px 48px 20px 20px;
  border-radius:14px; background:#111; color:#fff;
  box-shadow:0 8px 24px rgba(0,0,0,0.25);
  font-size:clamp(14px,2.4vw,20px); font-weight:600;
  text-align:center; line-height:1.35;
}
.close { position:absolute; top:10px; right:10px; width:34px; height:34px;
  border-radius:50%; border:none; background:rgba(255,255,255,0.12);
  color:#fff; display:flex; align-items:center; justify-content:center;
  cursor:pointer;
}
.close:hover { background:rgba(255,255,255,0.22); }

.sparkle {
  position:absolute; pointer-events:none; width:20px; height:20px; border-radius:50%;
  background:radial-gradient(circle,rgba(255,215,0,0.95) 0%,rgba(255,215,0,0.12) 60%,transparent 100%);
  transform:translate(-50%,-50%); animation:spark 450ms ease-out forwards; z-index:8;
}
@keyframes spark {
  from { opacity:1; transform:translate(-50%,-50%) scale(1); }
  to { opacity:0; transform:translate(-50%,-50%) scale(3); }
}

@media (max-width: 600px) {
  .bubble {
    max-width: 340px; padding:16px 36px 16px 16px;
    font-size:15px; border-radius:16px; margin:0 auto;
  }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="container">
    <h1><span class="highlight">La roue de la servitude</span></h1>
    <div class="board">
      <div class="wheel-area" id="wheelArea">
        <div class="pointer"></div>
        <canvas id="wheel" width="800" height="800"></canvas>
      </div>
      <div class="controls">
        <button id="spinBtn" class="primary">Tourner la roue</button>
        <div class="legend" id="countInfo"></div>
      </div>
    </div>
  </div>
</div>

<!-- Fen√™tre de r√©sultat -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="bubble" role="dialog" aria-modal="true">
    <div id="overlayText"></div>
    <div id="dynamicButtons"><!-- Les boutons seront charg√©s ici dynamiquement --></div>
    <button id="overlayClose" class="close" aria-label="Fermer">‚úï</button>
  </div>
</div>

<script>
/* === Exemple d‚Äôentr√©e === */
let ENTRIES = ["Exemple 1","Exemple 2","Exemple 3","Exemple 4"];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");
const overlayClose = document.getElementById("overlayClose");
const dynamicButtons = document.getElementById("dynamicButtons");

const CX = canvas.width/2, CY = canvas.height/2, R = canvas.width*0.48;
let angle = 0, spinning=false;

/* === Fonction dessin === */
function drawWheel(a=0){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const n = ENTRIES.length;
  const step = (Math.PI*2)/n;
  const colors = ["#f87171","#60a5fa","#34d399","#fbbf24","#a78bfa","#fb923c"];
  ctx.save(); ctx.translate(CX,CY); ctx.rotate(a);
  for(let i=0;i<n;i++){
    ctx.beginPath(); ctx.moveTo(0,0);
    ctx.arc(0,0,R,i*step,(i+1)*step);
    ctx.fillStyle=colors[i%colors.length]; ctx.fill();
    ctx.save();
    ctx.rotate(i*step+step/2);
    ctx.fillStyle="#111"; ctx.font="16px Poppins"; ctx.textAlign="right";
    ctx.fillText(ENTRIES[i],R-20,5);
    ctx.restore();
  }
  ctx.restore();
}

/* === Tourner la roue === */
document.getElementById("spinBtn").addEventListener("click",()=>{
  if(spinning) return;
  spinning=true;
  let vel=0.35;
  const decel=0.995;
  function step(){
    drawWheel(angle);
    angle+=vel;
    vel*=decel;
    if(vel<0.001){
      spinning=false;
      const idx=Math.floor(((Math.PI*1.5 - angle)%(2*Math.PI))/(2*Math.PI/ENTRIES.length));
      showOverlay(ENTRIES[idx]);
    } else requestAnimationFrame(step);
  }
  step();
});

/* === Fen√™tre r√©sultat === */
function showOverlay(text){
  overlayText.innerHTML=`üéØ R√©sultat :<br><br>${text}`;
  overlay.style.display="flex";
  overlay.setAttribute("aria-hidden","false");
  loadDynamicButtons();
}
overlayClose.addEventListener("click",()=>overlay.style.display="none");

/* === Chargement dynamique des boutons === */
function loadDynamicButtons(){
  if (!navigator.onLine) {
    dynamicButtons.innerHTML = "<p style='margin-top:12px;color:#aaa;'>‚ö†Ô∏è Vous √™tes hors ligne ‚Äî options de partage d√©sactiv√©es.</p>";
    return;
  }
  fetch("/larouedelaservitude/buttons.html")
    .then(r=>r.text())
    .then(html=>dynamicButtons.innerHTML=html)
    .catch(()=>dynamicButtons.innerHTML="<p style='margin-top:12px;color:#aaa;'>‚ùå Impossible de charger les boutons.</p>");
}

/* === R√©agit aux changements de connexion === */
window.addEventListener("online", loadDynamicButtons);
window.addEventListener("offline", () => {
  dynamicButtons.innerHTML = "<p style='margin-top:12px;color:#aaa;'>‚ö†Ô∏è Vous √™tes hors ligne ‚Äî options de partage d√©sactiv√©es.</p>";
});

/* === Service Worker === */
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("/larouedelaservitude/service-worker.js")
      .then(reg=>console.log("Service worker enregistr√©",reg.scope))
      .catch(err=>console.log("SW √©chec",err));
  });
}

/* === Dessin initial === */
drawWheel();
</script>

</body>
</html>


