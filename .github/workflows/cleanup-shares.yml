# ========================================
# WORKFLOW DE NETTOYAGE AUTOMATIQUE SÃ‰CURISÃ‰
# ========================================
# Fichier Ã  crÃ©er : .github/workflows/cleanup-shares.yml

name: Cleanup old share pages

on:
  # ExÃ©cution automatique tous les dimanches Ã  3h du matin
  schedule:
    - cron: '0 3 * * 0'
  
  # Permet aussi l'exÃ©cution manuelle depuis l'interface GitHub
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Find and delete old share pages
        run: |
          # DÃ©finir la limite d'Ã¢ge (30 jours = 2592000 secondes)
          AGE_LIMIT=2592000
          CURRENT_TIME=$(date +%s)
          DELETED_COUNT=0
          KEPT_COUNT=0
          
          echo "ğŸ” Recherche des fichiers Ã  supprimer..."
          echo "ğŸ“… Date actuelle: $(date)"
          echo "â° Fichiers de plus de 30 jours seront supprimÃ©s"
          echo ""
          
          # Parcourir tous les fichiers dans shares/
          if [ -d "shares" ]; then
            for file in shares/share-*.html; do
              # VÃ©rifier si le fichier existe (Ã©vite l'erreur si le dossier est vide)
              if [ -f "$file" ]; then
                # Obtenir la date de derniÃ¨re modification
                FILE_TIME=$(stat -c %Y "$file" 2>/dev/null || stat -f %m "$file")
                FILE_AGE=$((CURRENT_TIME - FILE_TIME))
                FILE_AGE_DAYS=$((FILE_AGE / 86400))
                
                # Si le fichier a plus de 30 jours
                if [ $FILE_AGE -gt $AGE_LIMIT ]; then
                  echo "ğŸ—‘ï¸  Suppression: $file (Ã¢ge: ${FILE_AGE_DAYS} jours)"
                  git rm "$file"
                  DELETED_COUNT=$((DELETED_COUNT + 1))
                else
                  echo "âœ… ConservÃ©: $file (Ã¢ge: ${FILE_AGE_DAYS} jours)"
                  KEPT_COUNT=$((KEPT_COUNT + 1))
                fi
              fi
            done
          else
            echo "âš ï¸  Le dossier 'shares' n'existe pas encore"
            exit 0
          fi
          
          echo ""
          echo "ğŸ“Š RÃ‰SUMÃ‰:"
          echo "   ğŸ—‘ï¸  Fichiers supprimÃ©s: $DELETED_COUNT"
          echo "   âœ… Fichiers conservÃ©s: $KEPT_COUNT"
          
          # Sauvegarder le nombre de fichiers supprimÃ©s pour l'Ã©tape suivante
          echo "DELETED_COUNT=$DELETED_COUNT" >> $GITHUB_ENV
      
      - name: Commit and push if changes
        run: |
          # VÃ©rifier s'il y a des changements Ã  commiter
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ’¾ Commit des changements..."
            git commit -m "ğŸ§¹ Auto-cleanup: Suppression de $DELETED_COUNT pages de plus de 30 jours"
            git push
            echo "âœ… Nettoyage effectuÃ© avec succÃ¨s!"
          else
            echo "â„¹ï¸  Aucun fichier Ã  supprimer (tous < 30 jours)"
          fi
      
      - name: Create cleanup summary
        if: always()
        run: |
          echo "## ğŸ§¹ Rapport de nettoyage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… **Date**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **Statistiques**:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—‘ï¸ Fichiers supprimÃ©s: $DELETED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Fichiers conservÃ©s: $KEPT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Prochain nettoyage**: Dimanche prochain Ã  3h00 UTC" >> $GITHUB_STEP_SUMMARY

# ========================================
# INSTRUCTIONS D'INSTALLATION
# ========================================

# 1ï¸âƒ£ CrÃ©er ce fichier dans votre repo :
#    .github/workflows/cleanup-shares.yml

# 2ï¸âƒ£ Copier tout le contenu ci-dessus

# 3ï¸âƒ£ Commit et push

# 4ï¸âƒ£ VÃ©rifier dans l'onglet "Actions" de votre repo GitHub

# ========================================
# COMMENT Ã‡A FONCTIONNE
# ========================================

# ğŸ“… EXÃ‰CUTION AUTOMATIQUE:
# - Tous les dimanches Ã  3h00 UTC
# - Vous pouvez changer l'heure en modifiant le cron
# - Format cron: 'minute heure jour mois jour_semaine'

# ğŸ” PROCESSUS:
# 1. Parcourt tous les fichiers dans /shares/
# 2. VÃ©rifie l'Ã¢ge de chaque fichier
# 3. Supprime uniquement les fichiers > 30 jours
# 4. Commit et push automatiquement
# 5. GÃ©nÃ¨re un rapport de nettoyage

# âœ… SÃ‰CURITÃ‰S:
# - Ne supprime QUE les fichiers share-*.html
# - Ne touche pas aux autres fichiers
# - 30 jours = ultra-safe (Facebook a dÃ©jÃ  tout en cache)
# - GÃ©nÃ¨re un log dÃ©taillÃ© Ã  chaque exÃ©cution

# ğŸ“Š MONITORING:
# - GitHub â†’ Votre repo â†’ Onglet "Actions"
# - Vous verrez tous les nettoyages effectuÃ©s
# - Chaque exÃ©cution gÃ©nÃ¨re un rapport dÃ©taillÃ©

# ğŸš€ TEST MANUEL:
# Pour tester immÃ©diatement sans attendre dimanche :
# 1. GitHub â†’ Votre repo â†’ Actions
# 2. Cliquez sur "Cleanup old share pages"
# 3. Bouton "Run workflow" â†’ Run workflow

# ========================================
# PERSONNALISATION
# ========================================

# CHANGER LA FRÃ‰QUENCE:
# - Tous les jours Ã  minuit: '0 0 * * *'
# - Tous les lundis: '0 3 * * 1'
# - Une fois par mois (1er du mois): '0 3 1 * *'

# CHANGER L'Ã‚GE LIMITE:
# - 7 jours: AGE_LIMIT=604800
# - 15 jours: AGE_LIMIT=1296000
# - 30 jours: AGE_LIMIT=2592000 (par dÃ©faut)
# - 60 jours: AGE_LIMIT=5184000

# ========================================
# ALTERNATIVE : LIMITE PAR NOMBRE DE FICHIERS
# ========================================

# Si vous prÃ©fÃ©rez garder seulement les X derniers fichiers
# au lieu de supprimer par Ã¢ge, remplacez l'Ã©tape
# "Find and delete old share pages" par :

# - name: Keep only last 1000 files
#   run: |
#     KEEP_COUNT=1000
#     
#     if [ -d "shares" ]; then
#       FILE_COUNT=$(ls -1 shares/share-*.html 2>/dev/null | wc -l)
#       
#       if [ $FILE_COUNT -gt $KEEP_COUNT ]; then
#         DELETE_COUNT=$((FILE_COUNT - KEEP_COUNT))
#         echo "ğŸ—‘ï¸  Suppression des $DELETE_COUNT fichiers les plus anciens..."
#         
#         ls -1t shares/share-*.html | tail -n $DELETE_COUNT | xargs git rm
#         
#         git commit -m "ğŸ§¹ Auto-cleanup: Limite de $KEEP_COUNT fichiers atteinte"
#         git push
#       else
#         echo "âœ… Seulement $FILE_COUNT fichiers (< $KEEP_COUNT)"
#       fi
#     fi
